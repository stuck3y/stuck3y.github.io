<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Nemo‑Pac vs Jellyfish</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    html,body{margin:0;height:100%;display:flex;justify-content:center;align-items:center;background:#001d2e;font-family:'Press Start 2P',cursive;color:#fff;overflow:hidden}
    #ui{position:absolute;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:40px;font-size:12px;pointer-events:none}
    canvas{background:#002b40;border:3px solid #1abc9c;border-radius:6px;image-rendering:pixelated}
    .mob{display:none}
    @media(max-width:768px){#ui{font-size:10px}.mob{display:grid;position:absolute;bottom:30px;left:50%;transform:translateX(-50%);grid-template-columns:repeat(3,60px);grid-gap:10px}.mob button{background:#0a3d55;border:2px solid #1abc9c;border-radius:50%;height:60px;width:60px;color:#fff;font-size:20px}.mob button:active{transform:translateY(2px)}#up{grid-column:2}#left{grid-column:1;grid-row:2}#right{grid-column:3;grid-row:2}#down{grid-column:2;grid-row:3}}
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="ui"><span id="score">SCORE 0</span><span id="lives">LIVES 3</span></div>
  <div class="mob">
    <button id="up">▲</button><button id="left">◀</button><button id="right">▶</button><button id="down">▼</button>
  </div>

  <script type="module">
    /* Nemo‑Pac vs Jellyfish ─ Safari‑friendly
       – Pac‑Man styled as clown‑fish (Nemo)
       – Ghosts drawn as jellyfish
       – Ghosts leave house reliably
    */

    const TILE=20,SPEED=6,GHOST_SPEED=4,POWER_MS=7000;
    const MAP=`############################
#............##............#
#.####.#####.##.#####.####.#
#o####.#####.##.#####.####o#
#.####.#####.##.#####.####.#
#............##............#
#.####.##.########.##.####.#
#......##....##....##......#
######.##### ## #####.######
     #.##### ## #####.#     
     #.##   G  G   ##.#     
######.## ###  ### ##.######
#P..........................#
######.## ######## ##.######
     #.##          ##.#     
######.## ######## ##.######
#............##............#
#.####.#####.##.#####.####.#
#o..##................##..o#
###.##.##.########.##.##.###
#......##....##....##......#
#.##########.##.##########.#
#..........................#
############################`;

    const rows=MAP.split('\n'),ROWS=rows.length,COLS=rows[0].length;
    const cvs=document.getElementById('c'),ctx=cvs.getContext('2d');
    cvs.width=COLS*TILE;cvs.height=ROWS*TILE;

    let board=[],dots=0,score=0,lives=3,fright=0,run=true;
    const pac={x:0,y:0,dx:0,dy:0,nx:0,ny:0,anim:0};
    const ghosts=[];

    /* ‑‑ Map parse ‑‑ */
    function initMap(){const jellyColors=['#e98eff','#9effff','#ffb3ff','#b5b3ff'];rows.forEach((row,y)=>{const arr=[];[...row].forEach((ch,x)=>{switch(ch){case'P':pac.x=x;pac.y=y;arr.push(' ');break;case'G':ghosts.push({x,y,dx:0,dy:0,startX:x,startY:y,fr:false,color:jellyColors[ghosts.length%jellyColors.length]});arr.push(' ');break;default:arr.push(ch);if(ch==='.'||ch==='o')dots++;}});board.push(arr);});}
    initMap();

    /* ‑‑ Helpers ‑‑ */
    const tile=(x,y)=>{x=Math.round(x);y=Math.round(y);return (board[y]&&board[y][x])||'#'};
    const pass=(x,y)=>tile(x,y)!=='#';
    const atCenter=v=>Math.abs(v-Math.round(v))<0.05;
    const wrap=o=>{if(o.x<-1)o.x=COLS-1;if(o.x>COLS)o.x=0};
    const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
    const dir=(nx,ny)=>{pac.nx=nx;pac.ny=ny};

    /* Controls */
    document.addEventListener('keydown',e=>{if(!run&&e.key==='Enter')return reset();switch(e.key){case'ArrowUp':case'w':dir(0,-1);break;case'ArrowDown':case's':dir(0,1);break;case'ArrowLeft':case'a':dir(-1,0);break;case'ArrowRight':case'd':dir(1,0);break;}});
    ['up','down','left','right'].forEach(id=>document.getElementById(id)?.addEventListener('click',()=>dir(id==='left'?-1:id==='right'?1:0,id==='up'?-1:id==='down'?1:0)));

    /* UI */
    const uS=document.getElementById('score'),uL=document.getElementById('lives');
    const COL={wall:'#00334d',dot:'#ffe66d',pellet:'#ff9e3d',fr:'#2ec4b6'};
    const hud=()=>{uS.textContent=`SCORE ${score}`;uL.textContent=`LIVES ${lives}`};

    /* Update */
    function step(dt){
      // Pac movement
      if(atCenter(pac.x)&&atCenter(pac.y)&&pass(pac.x+pac.nx,pac.y+pac.ny)){pac.dx=pac.nx;pac.dy=pac.ny;}
      if(!pass(pac.x+Math.sign(pac.dx)*0.6,pac.y+Math.sign(pac.dy)*0.6)){pac.dx=pac.dy=0;}
      pac.x+=pac.dx*dt*SPEED;pac.y+=pac.dy*dt*SPEED;wrap(pac);pac.anim+=dt*10;

      const cx=Math.round(pac.x),cy=Math.round(pac.y),cell=tile(cx,cy);
      if(cell==='.'||cell==='o'){board[cy][cx]=' ';score+=cell==='o'?50:10;dots--;hud();if(cell==='o'){fright=POWER_MS;ghosts.forEach(g=>g.fr=true);} }
      if(dots===0)return over(true);
      if(fright>0){fright-=dt*1000;if(fright<=0)ghosts.forEach(g=>g.fr=false);}

      // Ghost AI
      ghosts.forEach(g=>{
        if(atCenter(g.x)&&atCenter(g.y)){
          let opts=[[0,-1],[0,1],[-1,0],[1,0]].filter(([dx,dy])=>pass(g.x+dx,g.y+dy)&&!(dx===-g.dx&&dy===-g.dy));
          if(opts.length===0)opts=[[0,-1]]; // force upward escape if boxed
          const [dx,dy]=opts[Math.floor(Math.random()*opts.length)];g.dx=dx;g.dy=dy;}
        const sp=(g.fr?GHOST_SPEED*0.75:GHOST_SPEED);
        g.x+=g.dx*dt*sp;g.y+=g.dy*dt*sp;wrap(g);
        if(dist(g,pac)<0.7){if(g.fr){score+=200;g.x=g.startX;g.y=g.startY;g.fr=false;hud();}else crash();}}
      );
    }

    function crash(){lives--;hud();if(lives<=0)over(false);else{pac.x=pac.y=0;pac.dx=pac.dy=pac.nx=pac.ny=0;}}

    function over(win){run=false;ctx.fillStyle='#000c';ctx.fillRect(0,0,cvs.width,cvs.height);ctx.fillStyle='#ffe66d';ctx.textAlign='center';ctx.font='28px "Press Start 2P"';ctx.fillText(win?'YOU WIN!':'GAME OVER',cvs.width/2,cvs.height/2-20);ctx.font='14px "Press Start 2P"';ctx.fillText(`SCORE ${score}`,cvs.width/2,cvs.height/2+10);ctx.fillText('Press Enter',cvs.width/2,cvs.height/2+35);}  

    function reset(){board=[];dots=score=0;lives=3;ghosts.length=0;fright=0;run=true;initMap();hud();last=performance.now();requestAnimationFrame(loop);}

    /* Drawing helpers */
    function drawDot(x,y,radius,color){ctx.fillStyle=color;ctx.beginPath();ctx.arc(x*TILE+TILE/2,y*TILE+TILE/2,radius,0,Math.PI*2);ctx.fill();}

    function drawFish(){ctx.save();ctx.translate((pac.x+0.5)*TILE,(pac.y+0.5)*TILE);ctx.rotate(Math.atan2(pac.dy,pac.dx)||0);
      const bodyLen=TILE*0.9,bodyHt=TILE*0.6;const wave=Math.abs(Math.sin(pac.anim))*TILE*0.05;
      // Body
      ctx.fillStyle='#ff7e29';ctx.beginPath();ctx.ellipse(0,0,bodyLen/2,bodyHt/2+wave,0,0,Math.PI*2);ctx.fill();
      // White stripes
      ctx.fillStyle='#ffffff';ctx.fillRect(-bodyLen*0.15,-bodyHt*0.3,bodyLen*0.1,bodyHt*0.6);
      ctx.fillRect(bodyLen*0.05,-bodyHt*0.3,bodyLen*0.1,bodyHt*0.6);
      // Eye
      ctx.fillStyle='#000';ctx.beginPath();ctx.arc(bodyLen*0.25,-bodyHt*0.1,TILE*0.07,0,Math.PI*2);ctx.fill();
      // Tail
      ctx.fillStyle='#ff7e29';ctx.beginPath();ctx.moveTo(-bodyLen/2,0);ctx.lineTo(-bodyLen/2-TILE*0.3,bodyHt*0.3);ctx.lineTo(-bodyLen/2-TILE*0.3,-bodyHt*0.3);ctx.closePath();ctx.fill();
      ctx.restore();}

    function drawJelly(g){ctx.save();ctx.translate((g.x+0.5)*TILE,(g.y+0.5)*TILE);
      const r=TILE*0.4;ctx.fillStyle=g.fr?COL.fr:g.color;
      // Dome
      ctx.beginPath();ctx.arc(0,0,r,Math.PI,0);ctx.lineTo(r,0);ctx.lineTo(-r,0);ctx.closePath();ctx.fill();
      // Tentacles
      ctx.lineWidth=2;ctx.strokeStyle=ctx.fillStyle;
      for(let i=-1;i<=1;i+=1){ctx.beginPath();ctx.moveTo(i*r*0.5,0);ctx.lineTo(i*r*0.5,TILE*0.4+Math.sin(performance.now()/200+i)*4);ctx.stroke();}
      ctx.restore();}

    function render(){ctx.fillStyle=COL.wall;ctx.fillRect(0,0,cvs.width,cvs.height);
      for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){const t=board[y][x];if(t==='#'){ctx.fillStyle=COL.wall;ctx.fillRect(x*TILE,y*TILE,TILE,TILE);}else if(t==='.')drawDot(x,y,TILE*0.1,COL.dot);else if(t==='o')drawDot(x,y,TILE*0.25,COL.pellet);}  
      drawFish();ghosts.forEach(drawJelly);
    }

    /* Loop */
    let last=performance.now();function loop(t){if(!run)return;const dt=(t-last)/1000;last=t;step(dt);render();requestAnimationFrame(loop);}hud();requestAnimationFrame(loop);
  </script>
</body>
</html>
